{% extends 'plantilla.html' %}

{% block title %}{{ titulo_form }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card border rounded-3 shadow-sm" style="border: 3px solid #6c757d;">
      <div class="card-header bg-white text-center rounded-top-3 py-3" style="border: 3px solid #6c757d; border-bottom: none; border-radius: 0.75rem 0.75rem 0 0;">
        <h3 class="mb-0 fw-semibold text-dark">{{ titulo_form }}</h3>
      </div>
      <div class="card-body p-4" style="border: 3px solid #6c757d; border-top: none; border-radius: 0 0 0.75rem 0.75rem;">
        <form method="post" id="form-libro" novalidate>
          {% csrf_token %}
          <div class="mb-3">
            <label for="titulo" class="form-label fw-semibold">Título</label>
            <input 
              type="text" 
              class="form-control" 
              id="titulo" 
              name="titulo" 
              value="{% if libro %}{{ libro.titulo }}{% endif %}" 
              required 
              autocomplete="off"
            />
            <div class="invalid-feedback" style="display:none; color: #dc3545;">
              Por favor, ingresa un título válido (mínimo 2 caracteres).
            </div>
          </div>

          <div class="mb-3">
            <label for="año" class="form-label fw-semibold">Año</label>
            <input 
              type="number" 
              class="form-control" 
              id="año" 
              name="año" 
              value="{% if libro %}{{ libro.año }}{% endif %}" 
              min="1450" max="{{ current_year }}" 
              required 
              autocomplete="off"
              placeholder="Ejemplo: 2023"
            />
            <div class="invalid-feedback" style="display:none; color: #dc3545;">
              Por favor, ingresa un año válido (entre 1450 y {{ current_year }}).
            </div>
          </div>

          <div class="mb-3">
            <label for="genero" class="form-label fw-semibold">Género</label>
            <input 
              type="text" 
              class="form-control" 
              id="genero" 
              name="genero" 
              value="{% if libro %}{{ libro.genero }}{% endif %}" 
              required 
              autocomplete="off"
            />
            <div class="invalid-feedback" style="display:none; color: #dc3545;">
              Por favor, ingresa un género válido (mínimo 2 caracteres).
            </div>
          </div>

          <div class="mb-3">
            <label for="autor" class="form-label fw-semibold">Autor</label>
            <select class="form-select" id="autor" name="autor" required>
              <option value="">Selecciona un autor</option>
              {% for autor in autores %}
              <option value="{{ autor.id }}" {% if libro and libro.autor.id == autor.id %}selected{% endif %}>
                {{ autor.nombre_autor }}
              </option>
              {% endfor %}
            </select>
            <div class="invalid-feedback" style="display:none; color: #dc3545;">
              Por favor, selecciona un autor.
            </div>
          </div>

          <div class="mb-3">
            <label for="editorial" class="form-label fw-semibold">Editorial</label>
            <select class="form-select" id="editorial" name="editorial" required>
              <option value="">Selecciona una editorial</option>
              {% for editorial in editoriales %}
              <option value="{{ editorial.id }}" {% if libro and libro.editorial.id == editorial.id %}selected{% endif %}>
                {{ editorial.nombre_editorial }}
              </option>
              {% endfor %}
            </select>
            <div class="invalid-feedback" style="display:none; color: #dc3545;">
              Por favor, selecciona una editorial.
            </div>
          </div>

          <div class="d-flex justify-content-center gap-4 mt-5">
            <button type="submit" class="btn btn-success px-4 fw-semibold rounded">
              Guardar
            </button>
            <a href="{% url 'lista_libros' %}" class="btn btn-danger px-4 fw-semibold rounded">
              Cancelar
            </a>
            
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  /* Card con borde visible */
  .card {
    border-style: solid !important;
  }

  /* Inputs y selects con borde visible y validación */
  .form-control, .form-select {
    border-width: 2px !important;
    border-color: #6c757d !important;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }
  .form-control:focus, .form-select:focus {
    border-color: #0d6efd !important; /* bootstrap primary blue */
    box-shadow: 0 0 6px rgba(13, 110, 253, 0.4);
  }
  .is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 6px rgba(220, 53, 69, 0.5);
  }

  /* Mensajes de error */
  .invalid-feedback {
    font-weight: 600;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('form-libro');

    const tituloInput = document.getElementById('titulo');
    const añoInput = document.getElementById('año');
    const generoInput = document.getElementById('genero');
    const autorSelect = document.getElementById('autor');
    const editorialSelect = document.getElementById('editorial');

    const invalidTitulo = tituloInput.nextElementSibling;
    const invalidAño = añoInput.nextElementSibling;
    const invalidGenero = generoInput.nextElementSibling;
    const invalidAutor = autorSelect.nextElementSibling;
    const invalidEditorial = editorialSelect.nextElementSibling;

    const currentYear = new Date().getFullYear();
    const minYear = 1450; // Approximate start of printing press era

    function validateTextInput(input, invalidDiv, minLength = 2) {
      if (input.value.trim().length < minLength) {
        input.classList.add('is-invalid');
        invalidDiv.style.display = 'block';
        return false;
      } else {
        input.classList.remove('is-invalid');
        invalidDiv.style.display = 'none';
        return true;
      }
    }

    function validateYearInput(input, invalidDiv) {
      const year = parseInt(input.value, 10);
      if (isNaN(year) || year < minYear || year > currentYear) {
        input.classList.add('is-invalid');
        invalidDiv.style.display = 'block';
        return false;
      } else {
        input.classList.remove('is-invalid');
        invalidDiv.style.display = 'none';
        return true;
      }
    }

    function validateSelect(input, invalidDiv) {
      if (!input.value) {
        input.classList.add('is-invalid');
        invalidDiv.style.display = 'block';
        return false;
      } else {
        input.classList.remove('is-invalid');
        invalidDiv.style.display = 'none';
        return true;
      }
    }

    form.addEventListener('submit', function (e) {
      let valid = true;
      valid &= validateTextInput(tituloInput, invalidTitulo);
      valid &= validateYearInput(añoInput, invalidAño);
      valid &= validateTextInput(generoInput, invalidGenero);
      valid &= validateSelect(autorSelect, invalidAutor);
      valid &= validateSelect(editorialSelect, invalidEditorial);

      if (!valid) {
        e.preventDefault();
      }
    });

    tituloInput.addEventListener('input', () => validateTextInput(tituloInput, invalidTitulo));
    añoInput.addEventListener('input', () => validateYearInput(añoInput, invalidAño));
    generoInput.addEventListener('input', () => validateTextInput(generoInput, invalidGenero));
    autorSelect.addEventListener('change', () => validateSelect(autorSelect, invalidAutor));
    editorialSelect.addEventListener('change', () => validateSelect(editorialSelect, invalidEditorial));
  });
</script>
{% endblock %}
