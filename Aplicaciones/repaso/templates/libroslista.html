{% extends 'plantilla.html' %}

{% block title %}Lista de Libros{% endblock %}

{% block content %}
<div class="d-flex justify-content-end mb-3">
  <a href="{% url 'reporte' %}" class="btn btn-info">
    📄 Ver Reporte
  </a>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>📖 Lista de Libros</h2>
  <a href="{% url 'crear_libro' %}" class="btn btn-success">Agregar Libro</a>
</div>

<div class="table-responsive">
  <table class="table table-striped table-hover datatable" id="tabla-libros">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Título</th>
        <th>Año</th>
        <th>Género</th>
        <th>Autor</th>
        <th>Editorial</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for libro in libros %}
      <tr>
        <td>{{ libro.id }}</td>
        <td>{{ libro.titulo }}</td>
        <td>{{ libro.año }}</td>
        <td>{{ libro.genero }}</td>
        <td>{{ libro.autor.nombre_autor }}</td>
        <td>{{ libro.editorial.nombre_editorial }}</td>
        <td>
          <a href="{% url 'editar_libro' libro.id %}" class="btn btn-sm btn-warning">Editar</a>
          <button 
            class="btn btn-sm btn-danger btn-eliminar" 
            data-url="{% url 'eliminar_libro' libro.id %}" 
            data-nombre="{{ libro.titulo }}">
            Eliminar
          </button>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="text-center">No hay libros registrados</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // iziToast para mensajes de Django
  document.addEventListener('DOMContentLoaded', function() {
    {% if messages %}
      {% for message in messages %}
        iziToast.{{ message.tags|default:"info" }}({
          title: '{{ message.tags|title }}',
          message: '{{ message|escapejs }}',
          position: 'topRight',
          timeout: 5000
        });
      {% endfor %}
    {% endif %}

    // Confirmación de eliminación con iziToast
    $('.btn-eliminar').on('click', function(e) {
      e.preventDefault();
      const url = $(this).data('url');
      const nombre = $(this).data('nombre');
      iziToast.question({
        timeout: 20000,
        close: false,
        overlay: true,
        displayMode: 'once',
        id: 'confirm-delete',
        zindex: 999,
        title: 'Confirmar eliminación',
        message: `¿Estás seguro de eliminar el libro <b>${nombre}</b>?`,
        position: 'center',
        buttons: [
          ['<button><b>Sí, eliminar</b></button>', function (instance, toast) {
            window.location.href = url;
            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
          }, true],
          ['<button>Cancelar</button>', function (instance, toast) {
            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
          }]
        ]
      });
    });
  });

  // Inicializar DataTables con orden inicial descendente por ID para mostrar primero el último libro creado o editado
  $(document).ready(function() {
    $('#tabla-libros').DataTable({
      language: {
        url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json'
      },
      dom: "<'d-flex justify-content-between mb-3'<'dt-buttons'B><'dataTables_filter'f>>" + 
           "<'table-responsive'tr>" + 
           "<'d-flex justify-content-between mt-3'<'dataTables_info'i><'dataTables_paginate'p>>",
      buttons: [
        'copy', 'csv', 'excel', 'pdf', 'print', 'colvis'
      ],
      responsive: true,
      retrieve: true,
      order: [[0, 'desc']]
    });
  });
</script>
{% endblock %}
